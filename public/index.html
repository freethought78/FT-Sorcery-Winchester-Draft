<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorcery Winchester Cube Draft</title>
</head>
<body>
    <div id="stage">
        <h1>Connecting to draft server...</h1>
        <div id="messages"></div>
    </div>
</body>
</html>

<script>
userID = new URLSearchParams(window.location.search).get("id")

stage = document.getElementById('stage')
screen_width = window.innerWidth
screen_height = window.innerHeight

async function loadSorceryFont() {
	const SorceryFont = new FontFace('SorceryFont', 'url(http://173.168.139.242/SorceryFont.ttf)');

	try {
		await SorceryFont.load();
		document.fonts.add(SorceryFont);
		// Use the font
		document.body.style.fontFamily = 'SorceryFont';
	} catch (error) {
		console.error('Error loading font:', error);
	}
}

loadSorceryFont();

var inactive_tab_interval

//if the user is on another page, they might miss a state update, reload the page on page focus to stay up to date
window.addEventListener('focus', (event) => {
	clearInterval(inactive_tab_interval)
});

window.addEventListener('blur', (event) => {
	inactive_tab_interval = setInterval(()=>{
		requestStateUpdate()
	}, 1000)
});

//reload page on resize
window.addEventListener('resize', (event) => {
	window.location.reload();
});

function buildStage(state){
	if(state.phase == "configuration") configurationScreen(state)
	if(state.phase == "draft") draftScreen(state)
	if(state.phase == "await_client") awaitClientScreen(state)
}

function addscripts(ip){
	scripts = ['WebsocketHandler.js', 'ConfigurationScreen.js', 'DraftScreen.js', 'AwaitClientScreen.js']
	scripts.forEach((script)=>{
		s = document.createElement('script')
		s.src = `http://${ip}/${script}`
		document.body.appendChild(s)
	})
}

var pubip = "";

var urlParams = new URLSearchParams(window.location.search);
var session = urlParams.get('session');
var key = session.slice(0,32)
var value = session.slice(32)

if(session){
    var decrypted = decrypt(value, key);
    data = decrypted.slice(256)
    pubip = data
    addscripts(pubip)
}

function decrypt(encoded, key) {
    encoded = encoded.replace(/-/g, '+').replace(/_/g, '/');  // Convert URL-safe Base64 back to normal Base64
    while (encoded.length % 4 !== 0) encoded += '=';  // Add padding if needed
    let decrypted = atob(encoded);
    return xorEncrypt(decrypted, key);
}

function xorEncrypt(data, key) {
    return Array.from(data, (c, i) => String.fromCharCode(c.charCodeAt(0) ^ key.charCodeAt(i % key.length))).join("");
}



</script>
<style>
    body{
        color: #386dff;
        background-image: linear-gradient(to bottom, #010002, #06000e, #090016, #0c001d, #0b0024, #0a0129, #08012e, #040233, #030437, #02063b, #010840, #000944);
        overflow: hidden;
        margin: 0px;
    }
    #stage{
        height: 100vh;
        width: 100%;
    }
</style>